<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Grammar Sensei</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      * { font-size: 14px; }
      h1 { font-size: 24px; }
    </style>
  </head>
  <body>
    <h1>Grammar Sensei</h1>
    <br />
    <form onsubmit="go(event)">
      <label for="predicate">Predicate:</label>&nbsp;
      <input type="text" id="predicate" style="width: 200px" />&nbsp;
      <input type="reset">
      <input type="submit" value="Go">
    </form>
    <br />
    <br />
    <br />
    <table>
      <colgroup>
        <col span="1" style="width: 40px;">
        <col span="1" style="width: 200px;">
        <col span="1">
      </colgroup>
      <tbody id="choices"></tbody>
    </table>
    <br />
    <br />
    <div id="buttons"></div>

    <script src="data.js"></script>
    <script>
      const predicate = document.getElementById('predicate');
      const buttons = document.getElementById('buttons');
      const choices = document.getElementById('choices');

      function makeButton(title, callback) {
        var button = document.createElement('button');
        button.type = 'button';
        button.innerText = title;
        button.onclick = callback;
        return button;
      }

      function makeRow(word, description) {
        var row = document.createElement('tr');

        var col1 = document.createElement('td');
        var lookup = makeButton('?', function() {
          const url = 'https://jisho.org/search/' + word;
          window.open(url, '_blank');
        });
        col1.appendChild(lookup);
        row.appendChild(col1);

        var col2 = document.createElement('td');
        col2.innerText = word;
        row.appendChild(col2);

        var col3 = document.createElement('td');
        col3.innerText = description;
        row.appendChild(col3);

        return row;
      }

      function addChoice(title, word, description, callback) {
        const button = makeButton(title, function() {
          const row = makeRow(word, description);
          choices.insertBefore(row, choices.firstChild);
          buttons.innerHTML = '';
          callback();
        });
        buttons.appendChild(button);
      }

      function present(word, type, prev) {
        for (let rule of rules) {
          if (rule[0] == type && word.endsWith(rule[1])) {

            const prevType = prev[0];
            const newType = rule[2];

            for (let inv of invalids) {
              if (prevType == inv[0] && type == inv[1] && newType == inv[2]) {
                continue;
                  continue; 
                continue;
                  continue; 
                continue;
              }
            }

            const ref = rule;
            const name = names[newType];
            const newWord = word.substring(0, word.length - rule[1].length) + rule[3];
            const title = rule[1] + ' -> ' + rule[3] + ' (' + name + ')';
            addChoice(title, newWord, name, function() {
              present(newWord, newType, ref);
            });
          }
        }
        
      }

      function go(event) {
        event.preventDefault();
        buttons.innerHTML = '';
        choices.innerHTML = '';
        const word = predicate.value;

        for (let rule of rules) {
          if (rule[1] != rule[3] && rule[1] != '' && word.endsWith(rule[1])) {
            const type = rule[0];
            const name = names[type];
            const title = rule[1] + ' (' + name + ')';
            addChoice(title, word, name, function() {
              present(word, type, [0]);
            });
          }
        }
        return true;
      }
    </script>
  </body>
</html>